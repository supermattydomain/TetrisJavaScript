function randomBetween(b,a){return Math.floor(Math.random()*(a-b+1))+b}if(typeof(Tetris)==="undefined"){Tetris={}}function tableCellAt(b,c,a){return $(b[0].rows[c].cells[a])}Tetris.sounds={shapeFallBlocked:new Howl({urls:["sounds/bump.mp3","sounds/bump.ogg","sounds/bump.wav"]}),rowsZapped:new Howl({urls:["sounds/success.mp3","sounds/success.ogg","sounds/success.wav"]}),shapeShowBlocked:new Howl({urls:["sounds/negative-beeps.mp3","sounds/negative-beeps.ogg","sounds/negative-beeps.wav"]})};Tetris.Grid=function(b,a,c){this.div=c;if(c){this.createGrid(b,a)}};$.extend(Tetris.Grid.prototype,{createGrid:function(c,a){var e,d,b;b=$("<div>").addClass("border");this.table=$("<table>").addClass("grid");b.append(this.table);this.div.append(b);for(e=0;e<a;e++){d=$("<tr>");this.initRow(d,c);this.table.append(d)}},cellAt:function(b,a){return tableCellAt(this.table,b,a)},getWidth:function(){return this.table[0].rows[0].cells.length},getHeight:function(){return this.table[0].rows.length},isEmpty:function(b,a){return this.cellAt(b,a).hasClass("empty")},setShape:function(c,a,b){this.cellAt(c,a).attr("class",Tetris.shapeClasses[b])},initRow:function(c,b){var a;for(a=0;a<b;a++){c.append($("<td>").addClass("empty"))}},setEmpty:function(b,a){this.cellAt(b,a).attr("class","empty")},setRowEmpty:function(b){var a;for(a=0;a<this.getWidth();a++){this.setEmpty(b,a)}},clear:function(){var a;this.currentShape=null;for(a=0;a<this.getHeight();a++){this.setRowEmpty(a)}}});Tetris.Board=function(b,a,c){Tetris.Grid.call(this,b,a,c);this.nextType=this.randomShapeType();this.interval=null;this.running=false};Tetris.Board.prototype=new Tetris.Grid();$.extend(Tetris.Board.prototype,{randomShapeType:function(){return randomBetween(0,Tetris.shapeBitmaps.length-1)},createShape:function(){var a=this.nextType;this.nextType=this.randomShapeType();this.currentShape=new Tetris.Shape(this,0,Math.round(this.getWidth()/2-Tetris.shapeBitmaps[a][0].length/2),a);this.div.trigger(Tetris.eventNames.nextShapeChanged,this.nextType);if(!this.currentShape.show()){this.div.trigger(Tetris.eventNames.shapeShowBlocked)}},tick:function(){var a=this,b=function(){if(a.isRunning()){a.interval=setTimeout(function(){a.tick()},a.delay)}};if(this.currentShape){if(this.currentShape.fall()){b()}else{this.currentShape=null;this.zapFilledRows(function(){b();a.createShape()})}}else{this.createShape();b()}},isRowFilled:function(b){var a;for(a=0;a<this.getWidth();a++){if(this.isEmpty(b,a)){return false}}return true},insertBlankRow:function(){var a=$("<tr>");this.initRow(a,this.getWidth());this.table.prepend(a)},zapFilledRows:function(c){var a=this,d,b=$();for(d=this.getHeight()-1;d>=0;d--){if(this.isRowFilled(d)){b=b.add(this.table[0].rows[d])}}if(b.length){this.div.trigger(Tetris.eventNames.rowsZapped);b.effect("fade",this.delay/2);b.promise().done(function(){var e;b.remove();for(var e=0;e<b.length;e++){a.insertBlankRow()}c()})}else{this.div.trigger(Tetris.eventNames.shapeFallBlocked);c()}},drop:function(){if(this.currentShape){this.currentShape.drop()}},moveLeft:function(){if(this.currentShape){this.currentShape.moveLeft()}},moveRight:function(){if(this.currentShape){this.currentShape.moveRight()}},fall:function(){if(this.currentShape){this.currentShape.fall()}},rotate:function(a){if(this.currentShape){this.currentShape.rotate(a)}},setDelay:function(a){this.delay=a},start:function(){var a=this;if(!this.running){this.running=true;if(this.interval){clearTimeout(this.interval)}this.interval=setTimeout(function(){a.tick()},this.delay);this.div.trigger(Tetris.eventNames.boardStarted)}},stop:function(){if(this.interval){clearTimeout(this.interval);this.interval=undefined}if(this.running){this.div.trigger(Tetris.eventNames.boardStopped);this.running=false}},isRunning:function(){return this.running},toggleRunning:function(){if(this.isRunning()){this.stop()}else{this.start()}}});Tetris.Shape=function(c,d,a,b){this.board=c;this.row=d;this.col=a;this.type=b;this.rot=0;this.bitmap=Tetris.shapeBitmaps[this.type]};$.extend(Tetris.Shape.prototype,{empty:" ",getHeight:function(){return this.bitmap.length},getWidth:function(){return this.bitmap[0].length},emptyAt:function(b,a){return this.bitmap[b][a]===this.empty},filledAt:function(b,a){return !this.emptyAt(b,a)},hide:function(){var a,b;for(a=0;a<this.getHeight();a++){for(b=0;b<this.getWidth();b++){if(this.filledAt(a,b)){this.board.setEmpty(this.row+a,this.col+b)}}}},show:function(){var a,b;for(a=0;a<this.getHeight();a++){for(b=0;b<this.getWidth();b++){if(this.filledAt(a,b)){if(!this.board.isEmpty(this.row+a,this.col+b)){return false}this.board.setShape(this.row+a,this.col+b,this.type)}}}return true},rotate:function(b){var a,d,c,f,e=[];for(c=0;c<this.bitmap[0].length;c++){e[c]=[]}if(b){if(++this.rot>3){this.rot=0}for(c=0;c<this.getWidth();c++){for(f=0;f<this.getHeight();f++){d=c;a=e[c].length-1-f;if(a<0||a>=this.getHeight()||d>=this.bitmap[a].length){e[c][f]=this.empty}else{e[c][f]=this.bitmap[a][d]}}}}else{if(--this.rot<0){this.rot=3}for(c=0;c<this.getWidth();c++){for(f=0;f<this.getHeight(0);f++){d=e.length-1-c;a=f;if(d<0||a>=this.getHeight()||d>=this.bitmap[a].length){e[c][f]=this.empty}else{e[c][f]=this.bitmap[a][d]}}}}this.hide();if(this.blockedRotate(e)){this.show();return false}this.bitmap=e;this.show();return true},blockedRotate:function(b){var c,a;for(c=0;c<b.length;c++){for(a=0;a<b[c].length;a++){if(b[c][a]==this.empty){continue}if(this.row+c<0||this.row+c>=this.board.getHeight()){return true}if(this.col+a<0||this.col+a>=this.board.getWidth()){return true}if(!this.board.isEmpty(this.row+c,this.col+a)){return true}}}return false},blockedDown:function(){var b;var a;for(a=0;a<this.getWidth();a++){for(b=this.getHeight()-1;b>=0;b--){if(this.bitmap[b][a]!=this.empty){break}}if(b<0){continue}if(this.row+b+1>=this.board.getHeight()){return true}if(!this.board.isEmpty(this.row+b+1,this.col+a)){return true}}return false},blockedRight:function(){var b;var a;for(b=0;b<this.getHeight();b++){for(a=this.bitmap[b].length-1;a>=0;a--){if(this.bitmap[b][a]!=this.empty){break}}if(a<0){continue}if(this.col+a+1>=this.board.getWidth()){return true}if(!this.board.isEmpty(this.row+b,this.col+a+1)){return true}}return false},blockedLeft:function(){var b;var a;for(b=0;b<this.getHeight();b++){for(a=0;a<this.bitmap[b].length;a++){if(this.bitmap[b][a]!=this.empty){break}}if(a>=this.bitmap[b].length){continue}if(this.col+a-1<0){return true}if(!this.board.isEmpty(this.row+b,this.col+a-1)){return true}}return false},fall:function(){if(this.blockedDown()){return false}this.hide();this.row++;this.show();return true},moveLeft:function(){if(this.blockedLeft()){return false}this.hide();this.col--;this.show();return true},moveRight:function(){if(this.blockedRight()){return false}this.hide();this.col++;this.show();return true},drop:function(){while(this.fall()){}}});Tetris.NextShapeDisplay=function(b){var a=this.calcSize();Tetris.Grid.call(this,a.width,a.height,b)};Tetris.NextShapeDisplay.prototype=new Tetris.Grid();$.extend(Tetris.NextShapeDisplay.prototype,{calcSize:function(){var c,d,b=0,a=0;for(c=0;c<Tetris.shapeBitmaps.length;c++){a=Math.max(a,Tetris.shapeBitmaps[c].length);for(d=0;d<Tetris.shapeBitmaps[c].length;d++){b=Math.max(b,Tetris.shapeBitmaps[c][d].length)}}return{width:b,height:a}},isEmpty:function(b,a){return true},display:function(a){this.clear();this.currentShape=new Tetris.Shape(this,0,0,a);this.currentShape.show()}});$.extend(Tetris,{maxDelay:1000,delay:function(a){a=100-a;return a*Tetris.maxDelay/100},shapeBitmaps:[["XX","XX"],["  X  ","  X  ","  X  ","  X  "],[" X","XX","X "],["X ","XX"," X"],[" X "," XX"," X "],[" X "," X "," XX"],[" X "," X ","XX "]],shapeClasses:["blue","red","yellow","magenta","green","brightyellow","brightblue"],eventNames:{boardStarted:"Tetris.boardStarted",boardStopped:"Tetris.boardStopped",shapeFallBlocked:"Tetris.shapeFallBlocked",shapeShowBlocked:"Tetris.shapeShowBlocked",rowsZapped:"Tetris.rowsZapped",nextShapeChanged:"Tetris.nextShapeChanged"}});